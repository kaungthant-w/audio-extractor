<?php
header('Content-Type: application/json'); set_time_limit(600); ini_set('max_execution_time', 600); error_reporting(E_ERROR | E_PARSE); $uploadDir = 'uploads/'; $outputDir = 'processed/'; $statusDir = 'status/'; foreach ([$uploadDir, $outputDir, $statusDir] as $dir) { if (!file_exists($dir)) mkdir($dir, 0777, true); } $action = $_GET['action'] ?? 'process'; if ($action === 'list_files') { $scanned = @scandir($uploadDir); $files = array_diff($scanned ? $scanned : [], array('.', '..')); $validFiles = []; foreach ($files as $file) { if (preg_match('/\.(mp3|wav|ogg|m4a|webm|aac|flac|mp4|mkv|avi|mov)$/i', $file)) { $validFiles[] = $file; } } echo json_encode(['status' => 'success', 'files' => array_values($validFiles)]); exit; } if ($action === 'delete_file') { $fileName = basename($_POST['file'] ?? ''); if ($fileName && file_exists($uploadDir . $fileName)) { unlink($uploadDir . $fileName); echo json_encode(['status' => 'success']); } else { echo json_encode(['status' => 'error', 'message' => 'File not found']); } exit; } if ($action === 'check' && isset($_GET['job_id'])) { $jobId = basename($_GET['job_id']); $statusFile = $statusDir . $jobId . '.json'; $finalOutputMP3 = $outputDir . $jobId . '_final.mp3'; $finalOutputWAV = $outputDir . $jobId . '_final.wav'; $finalOutputSRT = $outputDir . $jobId . '_final.srt'; if (file_exists($finalOutputSRT)) { echo json_encode(['status' => 'success', 'url' => $finalOutputSRT, 'type' => 'srt']); } elseif (file_exists($finalOutputMP3)) { echo json_encode(['status' => 'success', 'url' => $finalOutputMP3]); } elseif (file_exists($finalOutputWAV)) { echo json_encode(['status' => 'success', 'url' => $finalOutputWAV]); } elseif (file_exists($statusFile)) { $statusData = json_decode(file_get_contents($statusFile), true); echo json_encode($statusData); } else { echo json_encode(['status' => 'processing', 'message' => 'AI is processing your audio...']); } exit; } if ($_SERVER['REQUEST_METHOD'] === 'POST') { $instrument = $_POST['instrument'] ?? 'flute'; $mixOptions = $_POST['mix_options'] ?? 'vocal,instrument'; $existingFile = $_POST['existing_file'] ?? ''; $jobId = uniqid('job_'); $inputPath = ''; if (!empty($existingFile)) { $existingFile = basename($existingFile); $existingPath = $uploadDir . $existingFile; if (file_exists($existingPath)) { $inputPath = $existingPath; } else { echo json_encode(['status' => 'error', 'message' => 'Selected file not found.']); exit; } } elseif (isset($_FILES['audio'])) { $audioFile = $_FILES['audio']; if ($audioFile['error'] === UPLOAD_ERR_OK) { $originalName = $audioFile['name']; $fileExt = strtolower(pathinfo($originalName, PATHINFO_EXTENSION)); $allowedExts = ['wav', 'mp3', 'ogg', 'webm', 'm4a', 'aac', 'flac', 'mp4', 'mkv', 'avi', 'mov']; if (!in_array($fileExt, $allowedExts)) { $fileExt = 'wav'; } $inputPath = $uploadDir . $jobId . '.' . $fileExt; if (!move_uploaded_file($audioFile['tmp_name'], $inputPath)) { echo json_encode(['status' => 'error', 'message' => 'File upload failed (move error).']); exit; } } else { $errCode = $audioFile['error']; $msg = 'Upload error code: ' . $errCode; if ($errCode === UPLOAD_ERR_INI_SIZE || $errCode === UPLOAD_ERR_FORM_SIZE) { $msg = 'File is too large (exceeds server limit).'; } elseif ($errCode === UPLOAD_ERR_PARTIAL) { $msg = 'File was only partially uploaded.'; } elseif ($errCode === UPLOAD_ERR_NO_FILE) { $msg = 'No file was uploaded.'; } echo json_encode(['status' => 'error', 'message' => $msg]); exit; } } else { if (empty($_FILES) && empty($_POST) && isset($_SERVER['CONTENT_LENGTH']) && $_SERVER['CONTENT_LENGTH'] > 0) { echo json_encode(['status' => 'error', 'message' => 'File too large (exceeds post_max_size).']); exit; } echo json_encode(['status' => 'error', 'message' => 'No file provided. Please select a file or record audio.']); exit; } file_put_contents($statusDir . $jobId . '.json', json_encode([ 'status' => 'processing', 'message' => 'Starting AI processing...' ])); $baseDir = str_replace('/', '\\', __DIR__); $absInputPath = $baseDir . '\\' . str_replace('/', '\\', $inputPath); $absScriptPath = $baseDir . '\\audio_engine.py'; $safeMixOptions = preg_replace('/[^a-z,]/', '', strtolower($mixOptions)); $effectsData = json_decode($_POST['effects_options'] ?? '{}', true); $effectsData['ai_engine'] = $_POST['engine'] ?? 'local'; $effectsData['api_key'] = $_POST['gemini_key'] ?? ''; $effectsFile = $baseDir . '\\temp\\effects_' . $jobId . '.json'; file_put_contents($effectsFile, json_encode($effectsData)); $batContent = "@echo off\r\n" . "set PYTHONIOENCODING=utf-8\r\n" . "cd /D \"$baseDir\"\r\n" . "python \"$absScriptPath\" \"$absInputPath\" \"$instrument\" \"$jobId\" \"$safeMixOptions\" \"$effectsFile\"\r\n"; $batFile = $baseDir . '\\temp\\run_' . $jobId . '.bat'; @mkdir(dirname($batFile), 0777, true); file_put_contents($batFile, $batContent); pclose(popen("start /B cmd /C \"$batFile\" > NUL 2>&1", 'r')); echo json_encode([ 'status' => 'started', 'job_id' => $jobId, 'message' => 'Processing started. AI is separating vocals and music...' ]); } else { echo json_encode(['status' => 'error', 'message' => 'No file provided.']); } ?>
